{% extends "base.html" %}
{% block title %}Empresas externas{% endblock %}

{% block content %}
{% set is_admin = (current_user.role == 'admin') %}

<div class="row justify-content-center">
  <div class="col-lg-10">

    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
      <div class="d-flex align-items-center gap-2">
        <h3 class="m-0">Empresas externas</h3>
        {% if not is_admin %}
          <span class="badge text-bg-secondary">Solo lectura</span>
        {% endif %}
      </div>

      <form class="d-flex gap-2" method="get" action="{{ url_for('empresas_index') }}">
        <input class="form-control"
               name="q"
               value="{{ q or '' }}"
               placeholder="Buscar por identificaci√≥n o nombre‚Ä¶">
        <div class="btn-group">
          <button class="btn btn-outline-primary" type="submit">Buscar</button>
          <a class="btn btn-outline-danger" href="{{ url_for('empresas_index') }}">Limpiar</a>
        </div>
      </form>

      {% if is_admin %}
        <a href="{{ url_for('empresas_create') }}" class="btn btn-primary btn-sm">
          Nueva empresa
        </a>
      {% endif %}
    </div>

    <div class="card shadow-sm border-0">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-striped align-middle m-0">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>Identificaci√≥n</th>
                <th>Nombre / raz√≥n social</th>
                <th class="text-end">
                  {% if is_admin %}Acciones{% endif %}
                </th>
              </tr>
            </thead>
            <tbody>
              {% for e in empresas %}
              <tr>
                <td>{{ e.id }}</td>
                <td><code class="small">{{ e.identificacion }}</code></td>
                <td>{{ e.nombre }}</td>
                <td class="text-end">
                  {% if is_admin %}
                    <a class="btn btn-sm btn-outline-primary"
                       href="{{ url_for('empresas_edit', empresa_id=e.id) }}">
                      Editar
                    </a>

                    <form class="d-inline delete-empresa-form"
                          method="POST"
                          action="{{ url_for('empresas_delete', empresa_id=e.id) }}">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                      <!-- campos ocultos para el captcha visual -->
                      <input type="hidden" name="cap_a">
                      <input type="hidden" name="cap_b">
                      <input type="hidden" name="cap_op" value="empresa_pattern">
                      <input type="hidden" name="cap_result">

                      <button type="button"
                              class="btn btn-sm btn-outline-danger"
                              onclick="openDeleteEmpresaModal(this, '{{ e.nombre|e }}')">
                        Eliminar
                      </button>
                    </form>
                  {% endif %}
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="{{ 4 if is_admin else 3 }}"
                    class="text-center py-4 text-muted">
                  Sin empresas registradas.
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</div>

{% if is_admin %}
<!-- Modal captcha visual para eliminar empresa -->
<div class="modal fade" id="deleteEmpresaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-wide">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirmar eliminaci√≥n de empresa</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <div class="modal-body">
        <p class="mb-2">
          Vas a eliminar la empresa <strong id="delete-empresa-nombre"></strong>.
          Esta acci√≥n <strong>no se puede deshacer</strong> y se registrar√° en la auditor√≠a.
        </p>

        <p class="mb-3">
          Para continuar, reproduce la siguiente secuencia de iconos de negocio:
        </p>

        <!-- Secuencia objetivo -->
        <div class="text-center mb-3">
          <div class="small text-muted mb-1">Secuencia objetivo</div>
          <div class="empresa-captcha-pattern d-inline-flex align-items-center justify-content-center">
            <span id="empresa-captcha-target"></span>
          </div>
        </div>

        <!-- Botones de iconos -->
        <div class="text-center mb-2">
          <div class="small text-muted mb-1">Haz clic en los iconos en el mismo orden</div>
          <div class="d-inline-flex gap-2 flex-wrap justify-content-center">
            <button type="button"
                    class="btn btn-sm btn-outline-secondary empresa-pattern-btn"
                    data-key="office">
              üè¢ Oficina
            </button>
            <button type="button"
                    class="btn btn-sm btn-outline-secondary empresa-pattern-btn"
                    data-key="factory">
              üè≠ F√°brica
            </button>
            <button type="button"
                    class="btn btn-sm btn-outline-secondary empresa-pattern-btn"
                    data-key="truck">
              üöö Log√≠stica
            </button>
            <button type="button"
                    class="btn btn-sm btn-outline-secondary empresa-pattern-btn"
                    data-key="deal">
              ü§ù Acuerdo
            </button>
          </div>
        </div>

        <!-- Secuencia clicada -->
        <div class="text-center mb-2">
          <div class="small text-muted mb-1">Tu secuencia</div>
          <div id="empresa-captcha-clicked" class="small fw-semibold"></div>
        </div>

        <div id="empresa-captcha-error"
             class="text-danger small text-center d-none">
          La secuencia no coincide. Int√©ntalo de nuevo.
        </div>
      </div>

      <div class="modal-footer">
        <button type="button"
                class="btn btn-secondary btn-sm"
                data-bs-dismiss="modal">
          Cancelar
        </button>
        <button type="button"
                class="btn btn-danger btn-sm"
                onclick="confirmDeleteEmpresaCaptcha()">
          S√≠, eliminar
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  let deleteEmpresaForm      = null;
  let expectedEmpresaPattern = [];
  let clickedEmpresaPattern  = [];

  const EMPRESA_ICON_MAP = {
    office:  { emoji: "üè¢", label: "oficina" },
    factory: { emoji: "üè≠", label: "f√°brica" },
    truck:   { emoji: "üöö", label: "log√≠stica" },
    deal:    { emoji: "ü§ù", label: "acuerdo" }
  };

  const EMPRESA_ICON_KEYS = Object.keys(EMPRESA_ICON_MAP); // ["office","factory","truck","deal"]

  function randomEmpresaPattern() {
    const patternLength = 3;  // longitud de la secuencia
    const pattern = [];
    for (let i = 0; i < patternLength; i++) {
      const idx = Math.floor(Math.random() * EMPRESA_ICON_KEYS.length);
      pattern.push(EMPRESA_ICON_KEYS[idx]);
    }
    return pattern;
  }

  function renderEmpresaPattern(pattern, elementId) {
    const el = document.getElementById(elementId);
    if (!el) return;
    el.textContent = pattern.map(k => EMPRESA_ICON_MAP[k].emoji).join(" ");
  }

  function renderEmpresaClickedPattern() {
    const el = document.getElementById("empresa-captcha-clicked");
    if (!el) return;
    el.textContent = clickedEmpresaPattern.map(k => EMPRESA_ICON_MAP[k].emoji).join(" ");
  }

  function openDeleteEmpresaModal(button, nombreEmpresa) {
    deleteEmpresaForm = button.closest("form");

    expectedEmpresaPattern = randomEmpresaPattern();
    clickedEmpresaPattern  = [];

    document.getElementById("delete-empresa-nombre").textContent = nombreEmpresa;
    renderEmpresaPattern(expectedEmpresaPattern, "empresa-captcha-target");
    renderEmpresaClickedPattern();
    document.getElementById("empresa-captcha-error").classList.add("d-none");

    // Asignar eventos a los botones de iconos
    document.querySelectorAll(".empresa-pattern-btn").forEach(btn => {
      btn.onclick = function () {
        const key = this.getAttribute("data-key");
        clickedEmpresaPattern.push(key);
        renderEmpresaClickedPattern();
      };
    });

    const modalEl = document.getElementById("deleteEmpresaModal");
    const modal   = new bootstrap.Modal(modalEl);
    modal.show();
  }

  function confirmDeleteEmpresaCaptcha() {
    const errorEl = document.getElementById("empresa-captcha-error");

    const expected = expectedEmpresaPattern;
    const clicked  = clickedEmpresaPattern;

    const okLength  = (clicked.length === expected.length);
    const okPattern = okLength && expected.every((k, i) => k === clicked[i]);

    if (okPattern && deleteEmpresaForm) {
      deleteEmpresaForm.querySelector('input[name="cap_a"]').value      = expected.join(",");
      deleteEmpresaForm.querySelector('input[name="cap_b"]').value      = clicked.join(",");
      deleteEmpresaForm.querySelector('input[name="cap_result"]').value = "ok";

      deleteEmpresaForm.submit();
      deleteEmpresaForm = null;

      const modalEl = document.getElementById("deleteEmpresaModal");
      const modal   = bootstrap.Modal.getInstance(modalEl);
      if (modal) modal.hide();
    } else {
      errorEl.classList.remove("d-none");
    }
  }
</script>

<style>
  .modal-wide {
    max-width: 600px;
  }

  .empresa-captcha-pattern {
    padding: 0.25rem 1.25rem;
    border-radius: 999px;
    border: 1px solid #dee2e6;
    background-color: #f8f9fa;
    font-size: 1.3rem;
    font-weight: 600;
    white-space: nowrap;
    min-width: 160px;
  }
</style>
{% endif %}
{% endblock %}