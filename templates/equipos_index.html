{% extends "base.html" %}
{% block title %}Equipos{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-11">

    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
      <h3 class="m-0">Equipos</h3>

      <form class="d-flex gap-2" method="get" action="{{ url_for('equipos_index') }}">
        <input class="form-control"
               name="q"
               value="{{ q or '' }}"
               placeholder="Buscar cÃ³digo, marca, modelo, empresaâ€¦">
        <div class="btn-group">
          <button class="btn btn-outline-primary" type="submit">Buscar</button>
          <a class="btn btn-outline-danger" href="{{ url_for('equipos_index') }}">Limpiar</a>
        </div>
      </form>

      {% if current_user.role == 'admin' %}
      <div class="d-flex flex-wrap gap-2">
        <a class="btn btn-primary" href="{{ url_for('equipos_create') }}">Nuevo equipo</a>

        <!-- Eliminar todos -->
        <form method="POST"
              action="{{ url_for('equipos_delete_all') }}"
              onsubmit="return confirm('âš ï¸ Esta acciÃ³n eliminarÃ¡ TODOS los equipos registrados.\n\nNo se puede deshacer.\n\nÂ¿Seguro que deseas continuar?');">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn btn-outline-danger">
            <i class="bi bi-trash3"></i> Eliminar todos
          </button>
        </form>

        <!-- Eliminar filtrados -->
        <form method="POST"
              action="{{ url_for('equipos_delete_filtered') }}"
              onsubmit="return confirm('âš ï¸ Esta acciÃ³n eliminarÃ¡ TODOS los equipos que coinciden con el filtro actual ({{ q or 'sin filtro' }}).\n\nNo se puede deshacer.\n\nÂ¿Seguro que deseas continuar?');">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="q" value="{{ q or '' }}">
          <button type="submit" class="btn btn-outline-danger">
            <i class="bi bi-trash3"></i> Eliminar equipos filtrados
          </button>
        </form>
      </div>
      {% endif %}
    </div>

    <div class="card shadow-sm border-0">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-striped align-middle m-0">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>CÃ³digo</th>
                <th>Tipo</th>
                <th>Marca/Modelo</th>
                <th>Empresa</th>
                <th>Estado</th>
                <th>Ingreso</th>
                <th class="text-end">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for e in equipos %}
              <tr>
                <td>{{ e.id }}</td>
                <td>{{ e.codigo_interno }}</td>
                <td><span class="badge text-bg-secondary">{{ e.tipo_equipo }}</span></td>
                <td>{{ e.marca or '-' }} / {{ e.modelo or '-' }}</td>
                <td>{{ e.empresa.nombre if e.empresa else 'â€”' }}</td>
                <td>
                  {% if e.estado == 'aprobado' %}
                    <span class="badge rounded-pill bg-success-subtle text-success-emphasis border border-success-subtle">
                      {{ e.estado }}
                      </span>
                  {% elif e.estado in ['en_revision'] %}
                    <span class="badge rounded-pill bg-secondary-subtle text-secondary-emphasis border border-secondary-subtle">
                      {{ e.estado }}
                      </span>
                  {% elif e.estado in ['pendiente'] %}
                    <span class="badge rounded-pill bg-warning-subtle text-warning-emphasis border border-warning-subtle">
                      {{ e.estado }}
                      </span>
                  {% elif e.estado in ['rechazado', 'devuelto'] %}
                    <span class="badge rounded-pill bg-danger-subtle text-danger-emphasis border border-danger-subtle">
                      {{ e.estado }}
                      </span>
                  {% else %}
                    <span class="badge text-bg-secondary">{{ e.estado }}</span>
                  {% endif %}
                </td>
                <td><small>{{ e.fecha_ingreso }}</small></td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-secondary"
                     href="{{ url_for('equipos_show', equipo_id=e.id) }}">Ver</a>
                  {% if current_user.role == 'admin' %}
                    <a class="btn btn-sm btn-outline-primary"
                       href="{{ url_for('equipos_edit', equipo_id=e.id) }}">Editar</a>
                    <a class="btn btn-sm btn-outline-secondary"
                       href="{{ url_for('audit_equipo_show', equipo_id=e.id) }}">
                      AuditorÃ­a
                    </a>

                    <form class="d-inline delete-equipo-form"
                          method="POST"
                          action="{{ url_for('equipos_delete', equipo_id=e.id) }}">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                      <!-- campos ocultos para el captcha -->
                      <input type="hidden" name="cap_a">
                      <input type="hidden" name="cap_b">
                      <input type="hidden" name="cap_op">
                      <input type="hidden" name="cap_result">

                      <button type="button"
                              class="btn btn-sm btn-outline-danger"
                              onclick="openDeleteEquipoModal(this, '{{ e.codigo_interno|e }}')">
                        Eliminar
                      </button>
                    </form>
                  {% endif %}
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="8" class="text-center py-4 text-muted">Sin resultados.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mt-3">
      <div class="text-muted small">Total: {{ total }}</div>
      <div class="btn-group">
        {% if page > 1 %}
          <a class="btn btn-outline-secondary btn-sm"
             href="{{ url_for('equipos_index', page=page-1, size=size, q=q) }}">Â« Anterior</a>
        {% endif %}
        {% if page*size < total %}
          <a class="btn btn-outline-secondary btn-sm"
             href="{{ url_for('equipos_index', page=page+1, size=size, q=q) }}">Siguiente Â»</a>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Modal confirmaciÃ³n con patrÃ³n de colores -->
<div class="modal fade" id="deleteEquipoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-wide">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirmar eliminaciÃ³n</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <div class="modal-body">
        <p class="mb-3">
          Vas a eliminar el equipo <strong id="delete-equipo-code"></strong>.
          Esta acciÃ³n <strong>no se puede deshacer</strong>.
        </p>

        <p class="mb-2">
          Para confirmar, sigue el siguiente patrÃ³n de colores:
        </p>

        <!-- PatrÃ³n a seguir -->
        <div class="text-center mb-3">
          <div class="small text-muted mb-1">PatrÃ³n objetivo</div>
          <div class="captcha-pattern d-inline-flex align-items-center justify-content-center">
            <span id="delete-captcha-pattern"></span>
          </div>
        </div>

        <!-- Botones de colores para hacer clic -->
        <div class="text-center mb-2">
          <div class="small text-muted mb-1">Haz clic en los colores en el mismo orden</div>
          <div class="d-inline-flex gap-2 flex-wrap justify-content-center">
            <button type="button" class="btn btn-sm btn-outline-danger pattern-btn" data-color="red">
              ðŸ”´ Rojo
            </button>
            <button type="button" class="btn btn-sm btn-outline-success pattern-btn" data-color="green">
              ðŸŸ¢ Verde
            </button>
            <button type="button" class="btn btn-sm btn-outline-primary pattern-btn" data-color="blue">
              ðŸ”µ Azul
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary pattern-btn" data-color="white">
              âšª Blanco
            </button>
          </div>
        </div>

        <!-- Muestra lo que el usuario ha clickeado -->
        <div class="text-center mb-2">
          <div class="small text-muted mb-1">Tu secuencia</div>
          <div id="delete-captcha-clicked" class="small fw-semibold"></div>
        </div>

        <div id="delete-captcha-error"
             class="text-danger small text-center d-none">
          El patrÃ³n no coincide. IntÃ©ntalo de nuevo.
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
          Cancelar
        </button>
        <button type="button" class="btn btn-danger btn-sm" onclick="confirmDeleteEquipoCaptcha()">
          SÃ­, eliminar
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  let deleteEquipoForm = null;
  let expectedPattern = [];
  let clickedPattern  = [];

  const COLOR_MAP = {
    red:   { emoji: "ðŸ”´", label: "Rojo"   },
    green: { emoji: "ðŸŸ¢", label: "Verde"  },
    blue:  { emoji: "ðŸ”µ", label: "Azul"   },
    white: { emoji: "âšª", label: "Blanco" }
  };

  function randomPattern() {
    const colors = ["red", "green", "blue", "white"];
    const patternLength = 3; // 3 pasos
    const pattern = [];
    for (let i = 0; i < patternLength; i++) {
      const idx = Math.floor(Math.random() * colors.length);
      pattern.push(colors[idx]);
    }
    return pattern;
  }

  function renderPattern(pattern, elementId) {
    const el = document.getElementById(elementId);
    if (!el) return;
    el.textContent = pattern
      .map(c => COLOR_MAP[c].emoji)
      .join(" ");
  }

  function renderClickedPattern() {
    const el = document.getElementById("delete-captcha-clicked");
    if (!el) return;
    el.textContent = clickedPattern
      .map(c => COLOR_MAP[c].emoji)
      .join(" ");
  }

  function openDeleteEquipoModal(button, codigo) {
    deleteEquipoForm = button.closest("form");

    // Generar nuevo patrÃ³n y limpiar selecciÃ³n
    expectedPattern = randomPattern();
    clickedPattern  = [];

    // Mostrar info
    document.getElementById("delete-equipo-code").textContent = codigo;
    renderPattern(expectedPattern, "delete-captcha-pattern");
    renderClickedPattern();
    document.getElementById("delete-captcha-error").classList.add("d-none");

    // Asignar listeners a los botones de colores
    document.querySelectorAll(".pattern-btn").forEach(btn => {
      btn.onclick = function () {
        const color = this.getAttribute("data-color");
        clickedPattern.push(color);
        renderClickedPattern();
      };
    });

    // Abrir modal
    const modalEl = document.getElementById("deleteEquipoModal");
    const modal   = new bootstrap.Modal(modalEl);
    modal.show();
  }

  function confirmDeleteEquipoCaptcha() {
    const errorEl = document.getElementById("delete-captcha-error");

    // Comprobar longitud y coincidencia exacta
    const okLength = (clickedPattern.length === expectedPattern.length);
    const okPattern = okLength && clickedPattern.every(
      (c, idx) => c === expectedPattern[idx]
    );

    if (okPattern) {
      if (deleteEquipoForm) {
        // Guardar el patrÃ³n esperado y el clickeado en campos ocultos
        deleteEquipoForm.querySelector('input[name="cap_a"]').value      = expectedPattern.join(",");
        deleteEquipoForm.querySelector('input[name="cap_b"]').value      = clickedPattern.join(",");
        deleteEquipoForm.querySelector('input[name="cap_op"]').value     = "pattern_colors";
        deleteEquipoForm.querySelector('input[name="cap_result"]').value = okPattern ? "ok" : "fail";

        deleteEquipoForm.submit();
        deleteEquipoForm = null;
      }
      const modalEl = document.getElementById("deleteEquipoModal");
      const modal   = bootstrap.Modal.getInstance(modalEl);
      if (modal) modal.hide();
    } else {
      errorEl.classList.remove("d-none");
    }
  }
</script>

<style>
  .modal-wide {
    max-width: 600px;
  }

  .captcha-pattern {
    padding: 0.25rem 1.25rem;
    border-radius: 999px;
    border: 1px solid #dee2e6;
    background-color: #f8f9fa;
    font-size: 1.2rem;
    font-weight: 600;
    white-space: nowrap;
    min-width: 160px;
  }
</style>
{% endblock %}